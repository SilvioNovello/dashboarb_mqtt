<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 PLC ‚Äî Dashboard Remota MQTT</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e17; --bg-card: #111827; --bg-card-hover: #1a2235;
    --border: #1e293b; --text-primary: #e2e8f0; --text-secondary: #94a3b8;
    --text-dim: #475569; --accent-blue: #3b82f6; --accent-green: #10b981;
    --accent-red: #ef4444; --accent-amber: #f59e0b; --accent-cyan: #06b6d4;
    --mono: 'JetBrains Mono', monospace; --sans: 'IBM Plex Sans', sans-serif;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--sans); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

  /* === LOGIN OVERLAY === */
  .login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 9999; }
  .login-overlay.hidden { display: none; }
  .login-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 36px 30px; width: 340px; text-align: center; }
  .login-logo { width: 56px; height: 56px; background: var(--accent-blue); border-radius: 14px; display: inline-flex; align-items: center; justify-content: center; font-family: var(--mono); font-weight: 700; font-size: 18px; color: white; margin-bottom: 18px; }
  .login-title { font-size: 1.25em; font-weight: 700; margin-bottom: 4px; }
  .login-sub { font-size: 0.78em; color: var(--text-dim); margin-bottom: 22px; }
  .login-input { width: 100%; padding: 11px 14px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: var(--mono); font-size: 0.9em; text-align: center; margin-bottom: 12px; }
  .login-input:focus { outline: none; border-color: var(--accent-blue); }
  .login-btn { width: 100%; padding: 12px; background: var(--accent-blue); border: none; border-radius: 8px; color: white; font-family: var(--sans); font-weight: 600; font-size: 0.95em; cursor: pointer; }
  .login-btn:hover { background: #2563eb; }
  .login-btn:disabled { background: #374151; cursor: not-allowed; }
  .login-error { color: var(--accent-red); font-size: 0.78em; margin-top: 10px; font-family: var(--mono); min-height: 1.2em; }
  .login-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 6px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* === HEADER === */
  .header { background: linear-gradient(180deg, #111827 0%, #0a0e17 100%); border-bottom: 1px solid var(--border); padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  .header-left { display: flex; align-items: center; gap: 12px; }
  .logo { width: 34px; height: 34px; background: var(--accent-blue); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-family: var(--mono); font-weight: 700; font-size: 13px; color: white; }
  .header-title { font-weight: 700; font-size: 1.05em; }
  .header-subtitle { font-size: 0.72em; color: var(--text-dim); font-family: var(--mono); }
  .header-right { display: flex; align-items: center; gap: 8px; }
  .conn-badge { display: flex; align-items: center; gap: 5px; font-family: var(--mono); font-size: 0.72em; padding: 5px 12px; border-radius: 16px; border: 1px solid var(--border); }
  .conn-badge.online { background: rgba(16,185,129,0.1); border-color: var(--accent-green); color: var(--accent-green); }
  .conn-badge.offline { background: rgba(239,68,68,0.1); border-color: var(--accent-red); color: var(--accent-red); animation: pulse-red 2s infinite; }
  @keyframes pulse-red { 50% { opacity: 0.5; } }
  .dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; }
  .nav-btn { background: none; border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); padding: 6px 10px; cursor: pointer; font-size: 1em; transition: all 0.2s; }
  .nav-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
  .nav-btn.active { border-color: var(--accent-blue); color: var(--accent-blue); background: rgba(59,130,246,0.1); }

  .page { display: none; max-width: 900px; margin: 0 auto; padding: 20px 16px; flex-direction: column; gap: 14px; }
  .page.active { display: flex; }
  .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
  .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; font-weight: 600; font-size: 0.82em; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.08em; }
  .tele-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
  .tele-item { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
  .tele-label { font-size: 0.68em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.06em; font-family: var(--mono); }
  .tele-value { font-family: var(--mono); font-size: 1.05em; font-weight: 600; margin-top: 2px; }
  .tele-value.highlight-green { color: var(--accent-green); }
  .tele-value.highlight-amber { color: var(--accent-amber); }
  .tele-value.highlight-cyan { color: var(--accent-cyan); }
  .output-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 8px; }
  .output-chip { text-align: center; padding: 10px 6px; border-radius: 8px; border: 1px solid var(--border); font-family: var(--mono); font-size: 0.72em; }
  .output-chip .pin-name { color: var(--text-dim); font-size: 0.85em; margin-bottom: 3px; }
  .output-chip .pin-val { font-weight: 700; font-size: 1.15em; }
  .output-chip.on { background: rgba(16,185,129,0.12); border-color: var(--accent-green); }
  .output-chip.on .pin-val { color: var(--accent-green); }
  .output-chip.off .pin-val { color: var(--text-dim); }
  .ctrl-row { display: flex; align-items: center; justify-content: space-between; padding: 11px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
  .ctrl-row:last-child { border-bottom: none; }
  .ctrl-label { font-weight: 500; display: flex; align-items: center; gap: 10px; }
  .ctrl-state { font-family: var(--mono); font-size: 0.78em; padding: 3px 10px; border-radius: 4px; font-weight: 600; }
  .ctrl-state.on { background: rgba(16,185,129,0.15); color: var(--accent-green); }
  .ctrl-state.off { background: rgba(239,68,68,0.1); color: var(--accent-red); }
  .toggle { position: relative; width: 46px; height: 25px; cursor: pointer; }
  .toggle input { display: none; }
  .toggle-track { width: 100%; height: 100%; background: #374151; border-radius: 13px; transition: background 0.3s; }
  .toggle input:checked + .toggle-track { background: var(--accent-green); }
  .toggle-thumb { position: absolute; top: 3px; left: 3px; width: 19px; height: 19px; background: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  .toggle input:checked ~ .toggle-thumb { transform: translateX(21px); }
  .btn { padding: 7px 16px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); color: var(--text-primary); font-family: var(--mono); font-size: 0.78em; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
  .btn:hover { background: var(--bg-card-hover); border-color: var(--accent-blue); }
  .btn-danger { border-color: #7f1d1d; color: var(--accent-red); }
  .btn-danger:hover { background: rgba(239,68,68,0.1); border-color: var(--accent-red); }
  .btn-green { background: var(--accent-green); color: white; border-color: var(--accent-green); }
  .log-area { background: #050810; border: 1px solid var(--border); border-radius: 8px; padding: 10px; max-height: 160px; overflow-y: auto; font-family: var(--mono); font-size: 0.7em; line-height: 1.7; color: var(--text-dim); }
  .log-area .log-time { color: var(--accent-cyan); } .log-area .log-in { color: var(--accent-green); }
  .log-area .log-out { color: var(--accent-amber); } .log-area .log-err { color: var(--accent-red); }
  .last-update { text-align: center; font-size: 0.7em; color: var(--text-dim); font-family: var(--mono); padding: 6px; }
  .settings-group { margin-bottom: 18px; }
  .settings-group-title { font-size: 0.8em; color: var(--accent-blue); font-family: var(--mono); margin-bottom: 8px; text-transform: uppercase; }
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 14px; }
  .settings-grid label { display: block; font-size: 0.75em; color: var(--text-secondary); margin-bottom: 3px; font-family: var(--mono); }
  .settings-grid input { width: 100%; padding: 8px 10px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: var(--mono); font-size: 0.85em; }
  .settings-grid input:focus { outline: none; border-color: var(--accent-blue); }
  .settings-actions { display: flex; gap: 10px; margin-top: 14px; }
  .settings-status { font-family: var(--mono); font-size: 0.75em; color: var(--text-dim); margin-top: 8px; }
  @media (max-width: 500px) { .tele-grid { grid-template-columns: repeat(2, 1fr); } .settings-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<!-- ===== LOGIN OVERLAY ===== -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-box">
    <div class="login-logo">ESP</div>
    <div class="login-title">Dashboard Login</div>
    <div class="login-sub">Autenticazione verificata dal dispositivo</div>
    <input type="text" id="loginUser" class="login-input" placeholder="Username" autocomplete="username">
    <input type="password" id="loginPass" class="login-input" placeholder="Password" autocomplete="current-password">
    <button class="login-btn" id="loginBtn" onclick="doLogin()">Accedi</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>
<div class="last-update">Created by S.N. üáÆüáπ </div>

<!-- ===== HEADER ===== -->
<div class="header">
  <div class="header-left">
    <div class="logo">ESP</div>
    <div><div class="header-title">Dashboard</div><div class="header-subtitle" id="headerMatr">MQTT Remote Control</div></div>
  </div>
  <div class="header-right">
    <div id="connBadge" class="conn-badge offline"><div class="dot"></div><span id="connText">Disconnesso</span></div>
    <button class="nav-btn" id="navSettings" onclick="showPage('settings')" title="Impostazioni">‚öô</button>
    <button class="nav-btn" onclick="doLogout()" title="Logout">‚èè</button>
  </div>
</div>

<!-- ===== PAGINA DASHBOARD ===== -->
<div id="pageDashboard" class="page active">
  <div class="card">
    <div class="card-header"><span>üì°</span> Telemetria</div>
    <div class="tele-grid">
      <div class="tele-item"><div class="tele-label">IP Locale</div><div class="tele-value" id="valIp">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Uptime</div><div class="tele-value highlight-cyan" id="valUptime">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">WiFi RSSI</div><div class="tele-value" id="valRssi">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Heap libero</div><div class="tele-value" id="valHeap">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Temperatura</div><div class="tele-value highlight-amber" id="valTemp">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Reboot</div><div class="tele-value" id="valCount">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Data</div><div class="tele-value" id="valDate">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Ora ESP</div><div class="tele-value" id="valTime">‚Äî</div></div>
      <div class="tele-item"><div class="tele-label">Firmware</div><div class="tele-value highlight-green" id="valFw">‚Äî</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><span>‚ö°</span> Uscite Hardware</div>
    <div class="output-grid">
      <div class="output-chip off" id="chipOut0"><div class="pin-name">OUT 0</div><div class="pin-val">‚Äî</div></div>
      <div class="output-chip off" id="chipOut1"><div class="pin-name">OUT 1</div><div class="pin-val">‚Äî</div></div>
      <div class="output-chip off" id="chipOut2"><div class="pin-name">OUT 2</div><div class="pin-val">‚Äî</div></div>
      <div class="output-chip off" id="chipOut3"><div class="pin-name">OUT 3</div><div class="pin-val">‚Äî</div></div>
      <div class="output-chip off" id="chipOut4"><div class="pin-name">OUT 4 (R)</div><div class="pin-val">‚Äî</div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><span>üéõ</span> Comandi</div>
    <div class="ctrl-row"><div class="ctrl-label">Uscita X1 <span class="ctrl-state off" id="stateX1">OFF</span></div><label class="toggle"><input type="checkbox" id="toggleX1" onchange="sendToggle('toggleX1',this.checked)"><div class="toggle-track"></div><div class="toggle-thumb"></div></label></div>
    <div class="ctrl-row"><div class="ctrl-label">Uscita X2 <span class="ctrl-state off" id="stateX2">OFF</span></div><label class="toggle"><input type="checkbox" id="toggleX2" onchange="sendToggle('toggleX2',this.checked)"><div class="toggle-track"></div><div class="toggle-thumb"></div></label></div>
    <div class="ctrl-row"><div class="ctrl-label">Reboot Counter</div><button class="btn" onclick="sendCmd({action:'resetCount'})">‚Ü∫ Reset</button></div>
    <!--<div class="ctrl-row"><div class="ctrl-label" style="color:var(--accent-red)">Riavvio ESP32</div><button class="btn btn-danger" onclick="if(confirm('Riavviare ESP32?'))sendCmd({action:'reboot'})">‚èª Reboot</button></div>-->
  </div>
  <div class="card">
    <div class="card-header"><span>üìã</span> Log MQTT <span style="flex:1"></span><button class="btn" onclick="document.getElementById('logArea').innerHTML=''" style="padding:3px 8px;font-size:0.7em">Pulisci</button></div>
    <div class="log-area" id="logArea"></div>
  </div>
  <div class="last-update">Ultimo aggiornamento: <span id="lastUpdate">mai</span></div>
  <div class="last-update">Created by S.N. üáÆüáπ </div>
</div>

<!-- ===== PAGINA SETTINGS ===== -->
<div id="pageSettings" class="page">
  <div class="card">
    <div class="card-header"><span>‚öô</span> Configurazione Broker MQTT</div>
    <div class="settings-group"><div class="settings-group-title">Connessione</div>
      <div class="settings-grid">
        <div><label>Broker Host</label><input type="text" id="cfgHost" value="public.cloud.shiftr.io"></div>
        <div><label>Porta WSS</label><input type="number" id="cfgPort" value="443"></div>
        <div><label>Username MQTT</label><input type="text" id="cfgUser" value="public"></div>
        <div><label>Password MQTT</label><input type="password" id="cfgPass" value="public"></div>
      </div>
    </div>
    <div class="settings-group"><div class="settings-group-title">Topic</div>
      <div class="settings-grid">
        <div><label>Topic base</label><input type="text" id="cfgTopicBase" value="silvio/plc14"></div>
        <div><label>Client ID (vuoto = auto)</label><input type="text" id="cfgClientId" value="" placeholder="auto"></div>
      </div>
    </div>
    <div class="settings-actions">
      <button class="btn btn-green" onclick="saveSettings()">üíæ Salva</button>
      <button class="btn" onclick="showPage('dashboard')">‚Üê Dashboard</button>
      <button class="btn btn-danger" onclick="if(confirm('Reset configurazione?')){localStorage.clear();location.reload();}">üóë Reset</button>
    </div>
    <div class="settings-status" id="settingsStatus"></div>
  </div>
</div>
<div class="last-update">Created by S.N. üáÆüáπ </div>

<script>
// ================================================
// STATO GLOBALE
// ================================================
let mqttClient = null;
let topicState = '', topicCmd = '', topicAuthReq = '', topicAuthResp = '';
let authToken = '';
let myClientId = '';
let authTimeout = null;

// ================================================
// SHA-256 in JavaScript (Web Crypto API)
// ================================================
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ================================================
// NAVIGAZIONE
// ================================================
function showPage(name) {
  document.getElementById('pageDashboard').classList.remove('active');
  document.getElementById('pageSettings').classList.remove('active');
  document.getElementById('navSettings').classList.remove('active');
  if (name === 'settings') {
    document.getElementById('pageSettings').classList.add('active');
    document.getElementById('navSettings').classList.add('active');
  } else {
    document.getElementById('pageDashboard').classList.add('active');
  }
}

// ================================================
// CONFIGURAZIONE
// ================================================
function getConfig() {
  return {
    host: document.getElementById('cfgHost').value.trim(),
    port: parseInt(document.getElementById('cfgPort').value),
    user: document.getElementById('cfgUser').value.trim(),
    pass: document.getElementById('cfgPass').value,
    clientId: document.getElementById('cfgClientId').value.trim() || ('dash_' + Math.random().toString(16).slice(2,8)),
    topicBase: document.getElementById('cfgTopicBase').value.trim()
  };
}

function saveSettings() {
  localStorage.setItem('mqtt_cfg', JSON.stringify(getConfig()));
  document.getElementById('settingsStatus').textContent = 'Salvato! Ricarica la pagina per applicare.';
}

function loadConfig() {
  try {
    const s = localStorage.getItem('mqtt_cfg');
    if (!s) return false;
    const c = JSON.parse(s);
    if (c.host) document.getElementById('cfgHost').value = c.host;
    if (c.port) document.getElementById('cfgPort').value = c.port;
    if (c.user) document.getElementById('cfgUser').value = c.user;
    if (c.pass) document.getElementById('cfgPass').value = c.pass;
    if (c.topicBase) document.getElementById('cfgTopicBase').value = c.topicBase;
    return true;
  } catch(e) { return false; }
}

// ================================================
// CONNESSIONE MQTT (solo per autenticazione)
// ================================================
function connectMqtt(onReady) {
  if (mqttClient && mqttClient.connected) { onReady(); return; }

  const cfg = getConfig();
  localStorage.setItem('mqtt_cfg', JSON.stringify(cfg));

  topicState = cfg.topicBase + '/state';
  topicCmd = cfg.topicBase + '/cmd';
  topicAuthReq = cfg.topicBase + '/auth/request';
  topicAuthResp = cfg.topicBase + '/auth/response';
  myClientId = cfg.clientId || ('dash_' + Math.random().toString(16).slice(2,8));

  mqttClient = mqtt.connect(`wss://${cfg.host}:${cfg.port}`, {
    clientId: myClientId,
    username: cfg.user,
    password: cfg.pass,
    clean: true,
    reconnectPeriod: 5000,
    connectTimeout: 10000,
    protocolVersion: 4
  });

  mqttClient.on('connect', () => {
    setConnStatus(true);
    mqttClient.subscribe(topicAuthResp);
    mqttClient.subscribe(topicState);
    onReady();
  });

  mqttClient.on('message', (topic, message) => {
    if (topic === topicAuthResp) handleAuthResponse(message.toString());
    if (topic === topicState && authToken) {
      try { updateUI(JSON.parse(message.toString())); }
      catch(e) {}
    }
  });

  mqttClient.on('error', (err) => { logMsg('err', err.message); setConnStatus(false); });
  mqttClient.on('close', () => { setConnStatus(false); });
  mqttClient.on('reconnect', () => { logMsg('out', 'Riconnessione...'); });
}

// ================================================
// LOGIN VIA MQTT
// ================================================
async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');

  if (!user || !pass) { errEl.textContent = 'Inserisci username e password'; return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="login-spinner"></span> Connessione...';
  errEl.textContent = '';

  // 1. Connetti al broker MQTT
  connectMqtt(async () => {
    // 2. Calcola SHA-256 della password
    const passHash = await sha256(pass);

    // 3. Invia richiesta auth
    const authReq = JSON.stringify({ user: user, pass_hash: passHash, client_id: myClientId });
    mqttClient.publish(topicAuthReq, authReq);
    logMsg('out', 'Auth request inviata...');

    // 4. Timeout 10 secondi
    authTimeout = setTimeout(() => {
      errEl.textContent = 'Dispositivo non raggiungibile (timeout)';
      btn.disabled = false;
      btn.textContent = 'Accedi';
    }, 10000);
  });
}

function handleAuthResponse(payload) {
  try {
    const resp = JSON.parse(payload);

    // Ignora risposte per altri client
    if (resp.client_id !== myClientId) return;

    clearTimeout(authTimeout);
    const btn = document.getElementById('loginBtn');
    const errEl = document.getElementById('loginError');

    if (resp.granted) {
      authToken = resp.token;
      // Salva sessione
      sessionStorage.setItem('auth_token', authToken);
      sessionStorage.setItem('auth_time', Date.now().toString());
      // Nascondi login, mostra dashboard
      document.getElementById('loginOverlay').classList.add('hidden');
      logMsg('in', 'Autenticazione riuscita!');
    } else {
      errEl.textContent = 'Credenziali non valide';
      btn.disabled = false;
      btn.textContent = 'Accedi';
    }
  } catch(e) {}
}

function doLogout() {
  authToken = '';
  sessionStorage.removeItem('auth_token');
  sessionStorage.removeItem('auth_time');
  document.getElementById('loginOverlay').classList.remove('hidden');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('loginBtn').disabled = false;
  document.getElementById('loginBtn').textContent = 'Accedi';
}

// Controlla se c'√® sessione valida (max 24h)
function hasValidSession() {
  const token = sessionStorage.getItem('auth_token');
  const time = parseInt(sessionStorage.getItem('auth_time') || '0');
  if (token && (Date.now() - time) < 86400000) {
    authToken = token;
    return true;
  }
  return false;
}

// ================================================
// COMANDI
// ================================================
function sendCmd(obj) {
  if (!mqttClient || !mqttClient.connected) { logMsg('err', 'Non connesso'); return; }
  mqttClient.publish(topicCmd, JSON.stringify(obj));
  logMsg('out', 'CMD: ' + JSON.stringify(obj));
}
function sendToggle(a, s) { sendCmd({ action: a, state: s }); }

// ================================================
// UI
// ================================================
function updateUI(d) {
  setText('valIp', d.ip||'‚Äî'); setText('valUptime', fmtUp(d.uptime||0));
  setText('valRssi', (d.rssi||'‚Äî')+' dBm'); setText('valHeap', d.heap ? (Math.round(d.heap/1024)+' KB') : '‚Äî');
  setText('valTemp', (d.temp||'‚Äî')+' ¬∞C'); setText('valCount', d.count??'‚Äî');
  setText('valDate', d.date||'‚Äî'); setText('valTime', d.time||'‚Äî'); setText('valFw', d.firmware||'‚Äî');
  if (d.matr) document.getElementById('headerMatr').textContent = 'Matricola: ' + d.matr;
  for (let i=0;i<=4;i++) { const v=d['out'+i],ch=document.getElementById('chipOut'+i); if(ch&&v!==undefined){const on=(v===1||v===true);ch.className='output-chip '+(on?'on':'off');ch.querySelector('.pin-val').textContent=on?'ON':'OFF';} }
  updTog('toggleX1','stateX1',d.x1); updTog('toggleX2','stateX2',d.x2);
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('it-IT');
}
function updTog(t,s,v){const on=(v===true||v===1);const te=document.getElementById(t),se=document.getElementById(s);if(te)te.checked=on;if(se){se.textContent=on?'ON':'OFF';se.className='ctrl-state '+(on?'on':'off');}}
function setText(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function fmtUp(s){const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60),ss=s%60;return d>0?d+'g '+h+'h '+m+'m':h>0?h+'h '+m+'m '+ss+'s':m+'m '+ss+'s';}
function setConnStatus(on){const b=document.getElementById('connBadge'),t=document.getElementById('connText');b.className='conn-badge '+(on?'online':'offline');t.textContent=on?'Connesso':'Disconnesso';}
function logMsg(type,msg){const a=document.getElementById('logArea');const now=new Date().toLocaleTimeString('it-IT');const cls=type==='in'?'log-in':type==='err'?'log-err':'log-out';const arr=type==='in'?'‚óÄ':type==='err'?'‚úñ':'‚ñ∂';a.innerHTML+=`<div><span class="log-time">${now}</span> <span class="${cls}">${arr} ${msg}</span></div>`;a.scrollTop=a.scrollHeight;while(a.children.length>150)a.removeChild(a.firstChild);}

// Enter per login
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !document.getElementById('loginOverlay').classList.contains('hidden')) doLogin();
});

// ================================================
// INIT
// ================================================
window.onload = () => {
  loadConfig();
  if (hasValidSession()) {
    // Sessione valida ‚Üí nascondi login, connetti
    document.getElementById('loginOverlay').classList.add('hidden');
    connectMqtt(() => { logMsg('in', 'Riconnesso con sessione esistente'); });
  }
  // Se no sessione ‚Üí mostra login (default)
};
</script>
</body>
</html>
